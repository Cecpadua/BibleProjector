name: Release Build

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      version:
        description: 'Release version (e.g., v1.0.0)'
        required: true
        default: 'v1.0.0'

jobs:
  create-release:
    runs-on: ubuntu-latest
    outputs:
      release_id: ${{ steps.create_release.outputs.id }}
      upload_url: ${{ steps.create_release.outputs.upload_url }}
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Extract version
      id: version
      run: |
        if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
          echo "VERSION=${{ github.event.inputs.version }}" >> $GITHUB_OUTPUT
        else
          echo "VERSION=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT
        fi
    
    - name: Create Release
      id: create_release
      uses: actions/create-release@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        tag_name: ${{ steps.version.outputs.VERSION }}
        release_name: CECP æŠ•å½±ç³»ç»Ÿ ${{ steps.version.outputs.VERSION }}
        body: |
          # CECP æŠ•å½±ç³»ç»Ÿ ${{ steps.version.outputs.VERSION }}
          
          ## ðŸ“‹ åŠŸèƒ½ç‰¹æ€§
          
          - âœ… åœ£ç»ç»æ–‡æŠ•å½±æ˜¾ç¤º
          - âœ… è‡ªå®šä¹‰é”®ç›˜å¿«æ·é”®
          - âœ… å¤šå±å¹•æ”¯æŒ
          - âœ… æ–‡å­—æ ·å¼è‡ªå®šä¹‰
          - âœ… èƒŒæ™¯å›¾ç‰‡æ”¯æŒ
          - âœ… å®žæ—¶é¢„è§ˆåŠŸèƒ½
          
          ## ðŸ“¦ ä¸‹è½½è¯´æ˜Ž
          
          è¯·æ ¹æ®æ‚¨çš„æ“ä½œç³»ç»Ÿé€‰æ‹©å¯¹åº”çš„å®‰è£…åŒ…ï¼š
          
          ### Windows ç”¨æˆ·
          - **æŽ¨è**: `CECP-æŠ•å½±-Setup-${{ steps.version.outputs.VERSION }}.exe` (å®‰è£…ç‰ˆ)
          - **ä¾¿æºç‰ˆ**: `CECP-æŠ•å½±-${{ steps.version.outputs.VERSION }}-win.zip` (å…å®‰è£…)
          
          ### macOS ç”¨æˆ·
          - **Intel èŠ¯ç‰‡**: `CECP-æŠ•å½±-${{ steps.version.outputs.VERSION }}-mac-x64.dmg`
          - **Apple Silicon (M1/M2)**: `CECP-æŠ•å½±-${{ steps.version.outputs.VERSION }}-mac-arm64.dmg`
          - **é€šç”¨ç‰ˆ**: `CECP-æŠ•å½±-${{ steps.version.outputs.VERSION }}-mac-universal.dmg`
          
          ### Linux ç”¨æˆ·
          - **AppImage** (æŽ¨è): `CECP-æŠ•å½±-${{ steps.version.outputs.VERSION }}.AppImage`
          - **Debian/Ubuntu**: `cecp-æŠ•å½±_${{ steps.version.outputs.VERSION }}_amd64.deb`
          - **RedHat/CentOS**: `cecp-æŠ•å½±-${{ steps.version.outputs.VERSION }}.x86_64.rpm`
          
          ## ðŸš€ å®‰è£…æŒ‡å—
          
          ### Windows
          1. ä¸‹è½½ `.exe` å®‰è£…åŒ…
          2. å³é”®é€‰æ‹©"ä»¥ç®¡ç†å‘˜èº«ä»½è¿è¡Œ"
          3. æŒ‰ç…§å®‰è£…å‘å¯¼å®Œæˆå®‰è£…
          
          ### macOS
          1. ä¸‹è½½å¯¹åº”çš„ `.dmg` æ–‡ä»¶
          2. åŒå‡»æ‰“å¼€ï¼Œå°†åº”ç”¨æ‹–æ‹½åˆ°"åº”ç”¨ç¨‹åº"æ–‡ä»¶å¤¹
          3. é¦–æ¬¡è¿è¡Œæ—¶ï¼Œè¯·åœ¨"ç³»ç»Ÿåå¥½è®¾ç½®" â†’ "å®‰å…¨æ€§ä¸Žéšç§"ä¸­å…è®¸è¿è¡Œ
          
          ### Linux
          #### AppImage æ–¹å¼
          ```bash
          chmod +x CECP-æŠ•å½±-${{ steps.version.outputs.VERSION }}.AppImage
          ./CECP-æŠ•å½±-${{ steps.version.outputs.VERSION }}.AppImage
          ```
          
          #### Debian/Ubuntu
          ```bash
          sudo dpkg -i cecp-æŠ•å½±_${{ steps.version.outputs.VERSION }}_amd64.deb
          sudo apt-get install -f  # å¦‚æžœæœ‰ä¾èµ–é—®é¢˜
          ```
          
          #### RedHat/CentOS/Fedora
          ```bash
          sudo rpm -i cecp-æŠ•å½±-${{ steps.version.outputs.VERSION }}.x86_64.rpm
          ```
          
          ## ðŸ”§ ç³»ç»Ÿè¦æ±‚
          
          - **Windows**: Windows 10 æˆ–æ›´é«˜ç‰ˆæœ¬
          - **macOS**: macOS 10.13 æˆ–æ›´é«˜ç‰ˆæœ¬
          - **Linux**: Ubuntu 18.04+, CentOS 7+, æˆ–å…¶ä»–çŽ°ä»£ Linux å‘è¡Œç‰ˆ
          
          ## ðŸ“ž æŠ€æœ¯æ”¯æŒ
          
          å¦‚æžœæ‚¨åœ¨ä½¿ç”¨è¿‡ç¨‹ä¸­é‡åˆ°é—®é¢˜ï¼Œè¯·åœ¨ GitHub Issues ä¸­åé¦ˆã€‚
          
          ---
          
          *æ­¤ç‰ˆæœ¬ç”± GitHub Actions è‡ªåŠ¨æž„å»ºå’Œå‘å¸ƒ*
        draft: false
        prerelease: false

  build:
    needs: create-release
    runs-on: ${{ matrix.os }}
    
    strategy:
      matrix:
        include:
          - os: windows-latest
            platform: win
            arch: x64
          - os: macos-latest
            platform: mac
            arch: universal
          - os: ubuntu-latest
            platform: linux
            arch: x64
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18.x'
        cache: 'npm'
    
    - name: Extract version
      id: version
      shell: bash
      run: |
        if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
          echo "VERSION=${{ github.event.inputs.version }}" >> $GITHUB_OUTPUT
        else
          echo "VERSION=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT
        fi
    
    - name: Install dependencies
      run: npm ci
    
    - name: Update version in package.json
      shell: bash
      run: |
        VERSION="${{ steps.version.outputs.VERSION }}"
        VERSION_NO_V="${VERSION#v}"
        npm version $VERSION_NO_V --no-git-tag-version
    
    - name: Install Linux dependencies
      if: matrix.os == 'ubuntu-latest'
      run: |
        sudo apt-get update
        sudo apt-get install -y libnss3-dev libatk-bridge2.0-dev libdrm2 libxkbcommon-dev libxcomposite-dev libxdamage-dev libxrandr-dev libgbm-dev libgtk-3-dev

    - name: Install macOS dependencies
      if: matrix.os == 'macos-latest'
      run: |
        npm install dmg-license --no-save || echo "dmg-license installation failed, continuing without it"

    - name: Build for Windows
      if: matrix.platform == 'win'
      run: npm run build:win
      env:
        GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
    
    - name: Build for macOS
      if: matrix.platform == 'mac'
      run: npm run build:mac
      env:
        GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        CSC_IDENTITY_AUTO_DISCOVERY: false
    
    - name: Build for Linux
      if: matrix.platform == 'linux'
      run: npm run build:linux
      env:
        GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
    
    - name: List build output
      shell: bash
      run: |
        echo "Build output directory contents:"
        ls -la dist/ || echo "No dist directory found"
        find dist/ -type f -name "*" 2>/dev/null || echo "No files in dist/"
        echo "Looking for Windows installer:"
        find dist/ -name "*.exe" 2>/dev/null || echo "No .exe files found"
        echo "Looking for Windows zip:"
        find dist/ -name "*.zip" 2>/dev/null || echo "No .zip files found"
        echo "Looking for macOS DMG:"
        find dist/ -name "*.dmg" 2>/dev/null || echo "No .dmg files found"
        echo "Looking for Linux AppImage:"
        find dist/ -name "*.AppImage" 2>/dev/null || echo "No .AppImage files found"
    
    # ä¸Šä¼  Windows æž„å»ºäº§ç‰©
    - name: Upload Windows installer
      if: matrix.platform == 'win'
      shell: bash
      run: |
        EXE_FILE=$(find dist/ -name "*.exe" | head -n 1)
        if [ -n "$EXE_FILE" ]; then
          echo "Found installer: $EXE_FILE"
          curl -L \
            -X POST \
            -H "Accept: application/vnd.github+json" \
            -H "Authorization: Bearer ${{ secrets.GITHUB_TOKEN }}" \
            -H "X-GitHub-Api-Version: 2022-11-28" \
            -H "Content-Type: application/octet-stream" \
            --data-binary @"$EXE_FILE" \
            "${{ needs.create-release.outputs.upload_url }}?name=CECP-æŠ•å½±-Setup-${{ steps.version.outputs.VERSION }}.exe"
        else
          echo "No .exe installer found"
        fi
      continue-on-error: true
    
    - name: Upload Windows portable
      if: matrix.platform == 'win'
      shell: bash
      run: |
        ZIP_FILE=$(find dist/ -name "*.zip" | head -n 1)
        if [ -n "$ZIP_FILE" ]; then
          echo "Found zip: $ZIP_FILE"
          curl -L \
            -X POST \
            -H "Accept: application/vnd.github+json" \
            -H "Authorization: Bearer ${{ secrets.GITHUB_TOKEN }}" \
            -H "X-GitHub-Api-Version: 2022-11-28" \
            -H "Content-Type: application/zip" \
            --data-binary @"$ZIP_FILE" \
            "${{ needs.create-release.outputs.upload_url }}?name=CECP-æŠ•å½±-${{ steps.version.outputs.VERSION }}-win.zip"
        else
          echo "No .zip file found"
        fi
      continue-on-error: true
    
    # ä¸Šä¼  macOS æž„å»ºäº§ç‰©
    - name: Upload macOS DMG
      if: matrix.platform == 'mac'
      uses: actions/upload-release-asset@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        upload_url: ${{ needs.create-release.outputs.upload_url }}
        asset_path: dist/CECP-æŠ•å½±-${{ steps.version.outputs.VERSION }}-universal.dmg
        asset_name: CECP-æŠ•å½±-${{ steps.version.outputs.VERSION }}-mac-universal.dmg
        asset_content_type: application/octet-stream
      continue-on-error: true
    
    # ä¸Šä¼  Linux æž„å»ºäº§ç‰©
    - name: Upload Linux AppImage
      if: matrix.platform == 'linux'
      uses: actions/upload-release-asset@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        upload_url: ${{ needs.create-release.outputs.upload_url }}
        asset_path: dist/CECP-æŠ•å½±-${{ steps.version.outputs.VERSION }}.AppImage
        asset_name: CECP-æŠ•å½±-${{ steps.version.outputs.VERSION }}.AppImage
        asset_content_type: application/octet-stream
      continue-on-error: true
    
    - name: Upload Linux DEB
      if: matrix.platform == 'linux'
      uses: actions/upload-release-asset@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        upload_url: ${{ needs.create-release.outputs.upload_url }}
        asset_path: dist/cecp-æŠ•å½±_${{ steps.version.outputs.VERSION }}_amd64.deb
        asset_name: cecp-æŠ•å½±_${{ steps.version.outputs.VERSION }}_amd64.deb
        asset_content_type: application/vnd.debian.binary-package
      continue-on-error: true
    
    - name: Upload Linux RPM
      if: matrix.platform == 'linux'
      uses: actions/upload-release-asset@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        upload_url: ${{ needs.create-release.outputs.upload_url }}
        asset_path: dist/cecp-æŠ•å½±-${{ steps.version.outputs.VERSION }}.x86_64.rpm
        asset_name: cecp-æŠ•å½±-${{ steps.version.outputs.VERSION }}.x86_64.rpm
        asset_content_type: application/x-rpm
      continue-on-error: true
    
    # ä¸Šä¼ æ‰€æœ‰æž„å»ºäº§ç‰©ä½œä¸ºå¤‡ä»½
    - name: Upload all artifacts
      uses: actions/upload-artifact@v4
      with:
        name: build-${{ matrix.platform }}-${{ matrix.arch }}
        path: dist/
        retention-days: 30
